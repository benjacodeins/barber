{% extends 'base.html' %}

{% block title %}Reservar Turno - Biondo Barbería{% endblock %}

{% block content %}
<section class="py-5" style="padding-top: 120px !important;">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="text-center mb-5">
                    <span class="text-uppercase gold-text fw-semibold" style="letter-spacing: 3px; font-size: 0.85rem;">
                        Reserva Online
                    </span>
                    <h1 class="display-5 fw-bold mt-2">Agenda tu Turno</h1>
                    <p class="text-muted">Selecciona tu barbero, servicio y horario preferido</p>
                </div>

                <div class="card p-4 p-md-5 shadow-sm">
                    <form id="reserva-form" method="post" action="{% url 'reservas:guardar' %}">
                        {% csrf_token %}

                        <div class="row mb-4">
                            <div class="col-md-6 mb-3 mb-md-0">
                                <label class="form-label fw-semibold">
                                    <i class="bi bi-person-circle me-2 gold-text"></i>Barbero
                                </label>
                                <select name="barbero" id="barbero" class="form-select" required
                                    hx-get="{% url 'reservas:horarios' %}" hx-target="#horarios-container"
                                    hx-include="[name='servicio'], [name='fecha']" hx-trigger="change"
                                    hx-indicator="#loading-indicator">
                                    <option value="" selected disabled>Selecciona un barbero</option>
                                    {% for barbero in barberos %}
                                    <option value="{{ barbero.id }}" {% if request.GET.barbero == barbero.id|stringformat:"s" %}selected{% endif %}>
                                        {{ barbero.nombre }}{% if barbero.especialidad %} - {{ barbero.especialidad }}{% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-semibold">
                                    <i class="bi bi-scissors me-2 gold-text"></i>Servicio
                                </label>
                                <select name="servicio" id="servicio" class="form-select" required
                                    hx-get="{% url 'reservas:horarios' %}" hx-target="#horarios-container"
                                    hx-include="[name='barbero'], [name='fecha']" hx-trigger="change"
                                    hx-indicator="#loading-indicator">
                                    <option value="" selected disabled>Selecciona un servicio</option>
                                    {% for servicio in servicios %}
                                    <option value="{{ servicio.id }}" {% if request.GET.servicio == servicio.id|stringformat:"s" %}selected{% endif %}>
                                        {{ servicio.nombre }} - ${{ servicio.precio }} ({{ servicio.duracion_minutos }}
                                        min)
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-calendar3 me-2 gold-text"></i>Fecha
                            </label>
                            <input type="date" name="fecha" id="fecha" class="form-control" min="{{ fecha_minima }}"
                                required hx-get="{% url 'reservas:horarios' %}" hx-target="#horarios-container"
                                hx-include="[name='barbero'], [name='servicio']" hx-trigger="change"
                                hx-indicator="#loading-indicator">
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-clock me-2 gold-text"></i>Horario Disponible
                            </label>

                            <div id="loading-indicator" class="htmx-indicator text-center py-3">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="text-muted mt-2 mb-0">Buscando horarios...</p>
                            </div>

                            <div id="horarios-container" class="mt-3">
                                <div class="alert alert-info text-center py-4">
                                    <i class="bi bi-info-circle me-2"></i>
                                    Selecciona un barbero, servicio y fecha para ver los horarios disponibles.
                                </div>
                            </div>
                        </div>

                        <div id="datos-cliente" style="display: none;">
                            <hr class="my-4" style="border-color: rgba(196, 163, 90, 0.3);">
                            <h5 class="mb-4"><i class="bi bi-person-vcard me-2 gold-text"></i>Tus Datos</h5>

                            <div class="row mb-3">
                                <div class="col-md-6 mb-3 mb-md-0">
                                    <label class="form-label">Nombre Completo</label>
                                    <input type="text" name="nombre_cliente" class="form-control"
                                        placeholder="Ej: Juan Pérez" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">WhatsApp</label>
                                    <input type="tel" name="whatsapp_cliente" class="form-control"
                                        placeholder="+54 9 11 1234-5678" required>
                                </div>
                            </div>

                            <input type="hidden" name="barbero_id" id="barbero_id_hidden">
                            <input type="hidden" name="servicio_id" id="servicio_id_hidden">
                            <input type="hidden" name="fecha_hora" id="fecha_hora_hidden">

                            <button type="submit" class="btn btn-primary btn-lg w-100 mt-3 shadow-sm">
                                <i class="bi bi-check-circle me-2"></i>Confirmar Reserva
                            </button>
                        </div>
                    </form>
                </div>

                <div class="text-center mt-4">
                    <a href="{% url 'reservas:landing' %}" class="text-decoration-none text-muted">
                        <i class="bi bi-arrow-left me-1"></i>Volver al inicio
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    /**
     * Esta función debe ser llamada por los botones que devuelva tu vista 'reservas:horarios'
     * Ejemplo del botón en el fragmento HTMX:
     * <button type="button" class="slot-btn btn btn-outline-dark" onclick="seleccionarHorario('2023-10-27T10:00', this)">10:00</button>
     */
    function seleccionarHorario(fechaHora, elemento) {
        // 1. Llenar los campos ocultos con los valores actuales
        document.getElementById('barbero_id_hidden').value = document.getElementById('barbero').value;
        document.getElementById('servicio_id_hidden').value = document.getElementById('servicio').value;
        document.getElementById('fecha_hora_hidden').value = fechaHora;

        // 2. Mostrar la sección de datos personales
        const datosClienteDiv = document.getElementById('datos-cliente');
        datosClienteDiv.style.display = 'block';

        // 3. Estilizar los botones de horario (limpiar otros y marcar el seleccionado)
        document.querySelectorAll('.slot-btn').forEach(btn => {
            btn.classList.remove('active', 'btn-primary');
            btn.classList.add('btn-outline-dark');
        });

        if (elemento) {
            elemento.classList.remove('btn-outline-dark');
            elemento.classList.add('active', 'btn-primary');
        }

        // 4. Scroll suave hacia los datos del cliente para mejorar UX
        datosClienteDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // Resetear el formulario de datos si se cambia barbero, servicio o fecha después de haber seleccionado un horario
    document.body.addEventListener('htmx:beforeRequest', function (evt) {
        if (evt.detail.target.id === 'horarios-container') {
            document.getElementById('datos-cliente').style.display = 'none';
        }
    });
</script>
{% endblock %}